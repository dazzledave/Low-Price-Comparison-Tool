{% extends "base.html" %}

{% block title %}Search Results{% endblock %}

{% block content %}
<div class="results-container">
    <h1>Search Results</h1>

    <div class="search-results">
        {% if filename %}
        <div class="image-recognition-results">
            <h2>Uploaded Image:</h2>
            <img src="{{ url_for('static', filename='uploads/' + filename) }}" alt="Uploaded Image" width="300">
        </div>
        {% endif %}

        <div class="search-details">
            <h2>{% if filename %}Recognized Item{% else %}Search Query{% endif %}:</h2>
            <p><strong>Item:</strong> {{ label }}</p>
            {% if filename %}
            <p><strong>Confidence:</strong> {{ confidence }}%</p>
            {% endif %}

            {% if filename and (confidence < 70 or not products and not melcom_products) %}
            <div class="search-suggestion">
                <p class="suggestion-text">
                    {% if confidence < 70 %}
                        The image recognition confidence is low. 
                    {% else %}
                        No matching products were found.
                    {% endif %}
                    Try searching by text instead:
                </p>
                <form action="{{ url_for('search_products') }}" method="POST" class="quick-search-form">
                    <input type="text" name="query" value="{{ label }}" placeholder="Enter product name...">
                    <button type="submit" class="btn">Search</button>
                </form>
            </div>
            {% endif %}

            {% if filename %}
            <form action="{{ url_for('submit_feedback') }}" method="POST">
                <input type="hidden" name="filename" value="{{ filename }}">
                <input type="hidden" name="label" value="{{ label }}">
                <p>Was this prediction correct?</p>
                <div class="feedback-buttons">
                    <button type="submit" name="feedback" value="Yes">Yes</button>
                    <button type="submit" name="feedback" value="No">No</button>
                </div>
            </form>
            {% endif %}

            <br>
            <a href="{{ url_for('upload_file') }}" class="btn">{% if filename %}Upload Another Image{% else %}New Search{% endif %}</a>
        </div>
    </div>

    <hr>

    <div id="loading-container" style="display: block;">
        <div class="loading-spinner"></div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar">
                <span class="progress-text">0%</span>
            </div>
        </div>
        <p id="loading-status">Searching for the best prices...</p>
    </div>

    <div id="results-section" style="display: none;">
        {% if cheapest_item %}
        <div class="best-deal-container">
            <h2>Best Deal Found!</h2>
            <div class="best-deal">
                <div class="best-deal-badge">Best Price</div>
                {% if cheapest_item.image %}
                    <img src="{{ cheapest_item.image }}" alt="{{ cheapest_item.name }}">
                {% endif %}
                <div class="best-deal-details">
                    <h3>{{ cheapest_item.name }}</h3>
                    <p class="price">
                        {% if cheapest_item.converted_price is not none and cheapest_item.converted_currency %}
                            {% if (cheapest_item.store == 'Amazon' and cheapest_item.converted_currency == 'USD') or (cheapest_item.store != 'Amazon' and cheapest_item.converted_currency == 'GHS') %}
                                {{ cheapest_item.converted_currency }} {{ cheapest_item.converted_price }}
                            {% else %}
                                {{ cheapest_item.converted_currency }} {{ cheapest_item.converted_price }}
                                <span class="original-price">({{ cheapest_item.original_price_with_symbol }})</span>
                            {% endif %}
                        {% else %}
                            {{ cheapest_item.price }}
                        {% endif %}
                    </p>
                    <p class="store">Available at {{ cheapest_item.store }}</p>
                    <a href="{{ cheapest_item.link }}" target="_blank" class="btn btn-primary">View Deal</a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="link-notice">
            <p><strong>Note:</strong> Product links may redirect to search pages or require login. This is normal for e-commerce sites.</p>
        </div>

        <!-- Jumia Products -->
        <div id="jumia-container" class="store-container">
            <div class="store-header">
                <span class="store-icon"><i class="fa-solid fa-store"></i></span>
                <span class="store-title">Jumia ({{ products|length }} products)</span>
            </div>
            <div class="product-card-grid">
            {% if products %}
                {% for product in products %}
                <div class="product-card {% if cheapest_item and product.name == cheapest_item.name and product.price == cheapest_item.price_display and cheapest_item.store == 'Jumia' %}cheapest-item{% elif cheapest_jumia and product.name == cheapest_jumia.name and product.price == cheapest_jumia.price %}store-cheapest{% endif %}">
                    <div class="product-image-wrap">
                        {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.name }}">
                        {% else %}
                            <div class="no-image">No Image</div>
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                        <div class="product-price-badge">
                            {% if product.converted_price is not none and product.converted_currency %}
                                {% if (product.store == 'Amazon' and product.converted_currency == 'USD') or (product.store != 'Amazon' and product.converted_currency == 'GHS') %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                {% else %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                    <span class="original-price">({{ product.original_price_with_symbol }})</span>
                                {% endif %}
                            {% else %}
                                {{ product.price }}
                            {% endif %}
                        </div>
                        <a href="{{ product.link }}" target="_blank" class="btn view-btn"><span class="btn-icon"><i class="fa-solid fa-arrow-up-right-from-square"></i></span> View Product</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>No matching Jumia products found.</p>
            {% endif %}
            </div>
        </div>

        <!-- Melcom Products -->
        <div id="melcom-container" class="store-container">
            <div class="store-header">
                <span class="store-icon"><i class="fa-solid fa-store"></i></span>
                <span class="store-title">Melcom ({{ melcom_products|length }} products)</span>
            </div>
            <div class="product-card-grid">
            {% if melcom_products %}
                {% for product in melcom_products %}
                <div class="product-card {% if cheapest_item and product.name == cheapest_item.name and product.price == cheapest_item.price_display and cheapest_item.store == 'Melcom' %}cheapest-item{% elif cheapest_melcom and product.name == cheapest_melcom.name and product.price == cheapest_melcom.price %}store-cheapest{% endif %}">
                    <div class="product-image-wrap">
                        {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.name }}">
                        {% else %}
                            <div class="no-image">No Image</div>
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                        <div class="product-price-badge">
                            {% if product.converted_price is not none and product.converted_currency %}
                                {% if (product.store == 'Amazon' and product.converted_currency == 'USD') or (product.store != 'Amazon' and product.converted_currency == 'GHS') %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                {% else %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                    <span class="original-price">({{ product.original_price_with_symbol }})</span>
                                {% endif %}
                            {% else %}
                                {{ product.price }}
                            {% endif %}
                        </div>
                        <a href="{{ product.link }}" target="_blank" class="btn view-btn"><span class="btn-icon"><i class="fa-solid fa-arrow-up-right-from-square"></i></span> View Product</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>No matching Melcom products found.</p>
            {% endif %}
            </div>
        </div>

        <!-- CompuGhana Products -->
        <div id="compughana-container" class="store-container">
            <div class="store-header">
                <span class="store-icon"><i class="fa-solid fa-store"></i></span>
                <span class="store-title">CompuGhana ({{ compughana_products|length }} products)</span>
            </div>
            <div class="product-card-grid">
            {% if compughana_products %}
                {% for product in compughana_products %}
                <div class="product-card {% if cheapest_item and product.name == cheapest_item.name and product.price == cheapest_item.price_display and cheapest_item.store == 'CompuGhana' %}cheapest-item{% elif cheapest_compughana and product.name == cheapest_compughana.name and product.price == cheapest_compughana.price %}store-cheapest{% endif %}">
                    <div class="product-image-wrap">
                        {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.name }}">
                        {% else %}
                            <div class="no-image">No Image</div>
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                        <div class="product-price-badge">
                            {% if product.converted_price is not none and product.converted_currency %}
                                {% if (product.store == 'Amazon' and product.converted_currency == 'USD') or (product.store != 'Amazon' and product.converted_currency == 'GHS') %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                {% else %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                    <span class="original-price">({{ product.original_price_with_symbol }})</span>
                                {% endif %}
                            {% else %}
                                {{ product.price }}
                            {% endif %}
                        </div>
                        <a href="{{ product.link }}" target="_blank" class="btn view-btn"><span class="btn-icon"><i class="fa-solid fa-arrow-up-right-from-square"></i></span> View Product</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>No matching CompuGhana products found.</p>
            {% endif %}
            </div>
        </div>

        <!-- Amazon Products -->
        <div id="amazon-container" class="store-container">
            <div class="store-header">
                <span class="store-icon"><i class="fa-brands fa-amazon"></i></span>
                <span class="store-title">Amazon ({{ amazon_products|length }} products)</span>
            </div>
            <div class="product-card-grid">
            {% if amazon_products %}
                {% for product in amazon_products %}
                <div class="product-card {% if cheapest_item and product.name == cheapest_item.name and product.price == cheapest_item.price_display and cheapest_item.store == 'Amazon' %}cheapest-item{% elif cheapest_amazon and product.name == cheapest_amazon.name and product.price == cheapest_amazon.price %}store-cheapest{% endif %}">
                    <div class="product-image-wrap">
                        {% if product.image %}
                            <img src="{{ product.image }}" alt="{{ product.name }}">
                        {% else %}
                            <div class="no-image">No Image</div>
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <div class="product-name" title="{{ product.name }}">{{ product.name }}</div>
                        <div class="product-price-badge">
                            {% if product.converted_price is not none and product.converted_currency %}
                                {% if (product.store == 'Amazon' and product.converted_currency == 'USD') or (product.store != 'Amazon' and product.converted_currency == 'GHS') %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                {% else %}
                                    {{ product.converted_currency }} {{ product.converted_price }}
                                    <span class="original-price">({{ product.original_price_with_symbol }})</span>
                                {% endif %}
                            {% else %}
                                {{ product.price }}
                            {% endif %}
                        </div>
                        <a href="{{ product.link }}" target="_blank" class="btn view-btn"><span class="btn-icon"><i class="fa-solid fa-arrow-up-right-from-square"></i></span> View Product</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>No matching Amazon products found.</p>
            {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingContainer = document.getElementById('loading-container');
    const resultsSection = document.getElementById('results-section');
    const progressBar = document.getElementById('progress-bar');
    const progressText = progressBar.querySelector('.progress-text');
    const loadingStatus = document.getElementById('loading-status');
    
    // Show loading immediately
    loadingContainer.style.display = 'block';
    resultsSection.style.display = 'none';

    // Function to check if any products were found
    function hasProducts() {
        return Boolean(document.querySelectorAll('.product-item').length);
    }

    // Function to update progress and status
    function updateProgress(percent, message) {
        progressBar.style.width = percent + '%';
        progressText.textContent = percent + '%';
        if (message) {
            loadingStatus.textContent = message;
        }
    }

    // Simulate progress while actual scraping happens
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += 20;
            updateProgress(progress, 
                progress === 40 ? 'Searching Jumia...' :
                progress === 80 ? 'Searching Melcom...' :
                'Processing results...'
            );
        }
    }, 300);

    // After results are ready (or timeout)
    setTimeout(() => {
        clearInterval(progressInterval);
        updateProgress(100, 'Search complete!');
        
        setTimeout(() => {
            loadingContainer.style.display = 'none';
            resultsSection.style.display = 'block';
            
            // Animate each store container
            document.querySelectorAll('.store-container').forEach((container, index) => {
                setTimeout(() => {
                    container.style.opacity = '1';
                    container.style.transform = 'translateY(0)';
                }, index * 200);
            });
        }, 500);
    }, hasProducts() ? 2000 : 3000);
});
</script>
{% endblock %}
